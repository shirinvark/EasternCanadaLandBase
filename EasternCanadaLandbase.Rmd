---
title: "EasternCanadaLandbase Manual"
subtitle: "Spatial data preparation for Eastern Canada"
date: "Last updated: 2026-02-14"
output:
  bookdown::html_document2:
    toc: true
    toc_float: true
    theme: sandstone
    number_sections: false
---

# EasternCanadaLandbase

This module builds a planning-ready forest landbase for AAC calculations.

---

# 1. Conceptual Flow

```
StandAgeMap  +  LandCover  +  CPCAD
        ↓
analysisUnitMap
        ↓
Protected area masking
        ↓
netProductiveForest
        ↓
Landbase container
```

---

# 2. Analysis Unit Definition

Forest classes derived from SCANFI (reclassified to NTEMS):

| SCANFI Code | Forest Type   | AU Code |
|------------|--------------|--------|
| 210        | Coniferous   | 1      |
| 220        | Deciduous    | 2      |
| 230        | Mixedwood    | 3      |
| 240        | Treed Wetland| 4      |

## R Implementation


```{r setup, include=FALSE}
analysisUnitMap <- LandCover
analysisUnitMap[] <- 0

analysisUnitMap[LandCover == 210] <- 1
analysisUnitMap[LandCover == 220] <- 2
analysisUnitMap[LandCover == 230] <- 3
analysisUnitMap[LandCover == 240] <- 4
```

---

# 3. Protected Area Masking

Protected areas (CPCAD) are rasterized and removed:

```{r setup, include=FALSE}
protectedRaster <- terra::rasterize(
  CPCAD,
  PlanningGrid_250m,
  field = 1,
  background = 0
)

analysisUnitMap <- terra::ifel(
  protectedRaster == 1,
  0,
  analysisUnitMap
)
```

---

# 4. Net Productive Forest Definition

A cell is considered productive if:

- It belongs to a forest AU (AU > 0)
- Stand age exists
- Stand age > 0

Mathematically:

```
NPF = 1  if  (AU > 0 ∧ Age > 0)
NPF = 0  otherwise
```

R implementation:

```{r setup, include=FALSE}
netProductiveForest <- terra::ifel(
  analysisUnitMap > 0 &
    !is.na(standAgeMap) &
    standAgeMap > 0,
  1,
  0
)
```

---

# 5. Final Landbase Object

```{r setup, include=FALSE}
Landbase <- list(
  planningRaster       = PlanningGrid_250m,
  landcover            = LandCover,
  standAgeMap          = standAgeMap,
  analysisUnitMap      = analysisUnitMap,
  netProductiveForest  = netProductiveForest
)
```

---


# 6. Area by AU × Age (Next Step)

We compute the area table that will feed AAC.

### Mathematical Definition

```
Area(i,j) = Σ cells where (AU == i ∧ AgeClass == j)
```

### Example R Skeleton

```{r}
library(dplyr)

df <- as.data.frame(c(netProductiveForest,
                      analysisUnitMap,
                      standAgeMap),
                    na.rm = TRUE)

colnames(df) <- c("NPF", "AU", "Age")

areaTable <- df %>%
  filter(NPF == 1) %>%
  group_by(AU, Age) %>%
  summarise(CellCount = n(), .groups = "drop")
```

---

# 7. AAC Scaffold (Conceptual)

## Simple Sustained Yield

```
AAC ≈ Total Productive Area / Rotation Length
```

## Structured AAC by AU

```
AAC_i = Σ ( Area_i,age × Yield_i,age ) / Rotation_i
```

## R Scaffold

```{r}
AAC_table <- areaTable %>%
  mutate(
    Yield = 0,        # placeholder
    Rotation = 80,    # example
    Volume = CellCount * Yield
  ) %>%
  group_by(AU) %>%
  summarise(
    AAC = sum(Volume) / unique(Rotation)
  )
```

---

# 8. Module Output Summary

The module produces:

- `standAgeMap`
- `analysisUnitMap`
- `netProductiveForest`
- `Landbase` (container object)

These objects become the input for the AAC module.